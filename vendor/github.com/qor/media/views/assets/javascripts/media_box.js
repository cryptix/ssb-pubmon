"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(e){function t(e){var t=/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/,i=e.match(t);return!(!i||11!=i[7].length)&&i[7]}function i(t,o){this.$element=e(t),this.options=e.extend({},i.DEFAULTS,e.isPlainObject(o)&&o),this.init()}var o=e("body"),a=e(document),n="qor.medialibrary.select",s="click."+n,r=".qor-field__mediabox-list",d=".qor-field__mediabox-item",l=".qor-field__mediabox-data",m="qor-bottomsheets__mediabox";return i.prototype={constructor:i,init:function(){var e=this.$element;this.SELECT_MEDIABOX_UNDO_TEMPLATE=e.find('[name="media-box-undo-delete"]').html(),this.bind(),this.initSelectedMedia()},bind:function(){a.off("reload.qor.bottomsheets").on("reload.qor.bottomsheets","."+m,this.reloadData.bind(this)),this.$element.off(s).off("change.qor.cropper").on(s,"[data-mediabox-url]",this.openBottomSheets.bind(this)).on(s,".qor-cropper__toggle--delete",this.deleteSelected.bind(this)).on(s,".qor-cropper__toggle--undo",this.undoDeleteSelected.bind(this)).on("change.qor.cropper","textarea.qor-file__options",this.imageCrop.bind(this))},unbind:function(){a.off("reload.qor.bottomsheets","."+m),this.$element.off(s).off("change.qor.cropper")},deleteSelected:function(t){var i=e(t.target);return i.closest(d).addClass("is_deleted").append(this.SELECT_MEDIABOX_UNDO_TEMPLATE).find(".qor-file__list").hide(),this.updateMediaLibraryData(i.closest(r)),this.$element.find(l).data("isDeleted",!0),!1},undoDeleteSelected:function(t){var i=e(t.target);return i.closest(d).removeClass("is_deleted").find(".qor-file__list").show(),this.updateMediaLibraryData(i.closest(r)),i.closest(".qor-fieldset__alert").remove(),this.$element.find(l).data("isDeleted",!1),!1},imageCrop:function(t){var i=e(t.target).closest(d);this.syncImageCrop(i,this.resetImages)},openBottomSheets:function(t){var i,a=e(t.target).closest("[data-mediabox-url]"),n=a.data();n.isDisabled||(this.BottomSheets=o.data("qor.bottomsheets"),this.bottomsheetsData=n,this.$parent=i=a.closest(".qor-field__mediabox"),this.$selectFeild=i.find(r),n.url=n.mediaboxUrl,this.SELECT_MANY_SELECTED_ICON=e('[name="media-box-select-many-selected-icon"]').html(),this.SELECT_MANY_HINT=e('[name="media-box-select-many-hint"]').html(),this.TEMPLATE_IMAGE=i.find('[name="media-box-template"]').html(),this.TEMPLATE_FILE=i.find('[name="media-box-file-template"]').html(),this.TEMPLATE_UPLOADEDVIDEO=i.find('[name="media-box-uploadedvideo-template"]').html(),this.TEMPLATE_VIDEOLINK=i.find('[name="media-box-videolink-template"]').html(),this.SELECT_MEDIABOX_UNDO_TEMPLATE=i.find('[name="media-box-undo-delete"]').html(),this.BottomSheets.open(n,this.handleSelectMany.bind(this)))},initSelectedMedia:function(){var e,t=this.$element,i=t.find(d),o=JSON.parse(t.find(l).val());if(o)for(var a=0;a<o.length;a++)e=i.filter('[data-primary-key="'+o[a].ID+'"]'),e.data().description||e.data("description",o[a].Description)},initMedia:function(){var t,i,o,a=this.$selectFeild,n=a.find(d).not(".is_deleted"),s=this.$bottomsheets.find("tbody tr"),r=this;n.each(function(){o=e(this).data().primaryKey,t=s.filter('[data-primary-key="'+o+'"]').addClass("is_selected"),r.changeIcon(t,!0)}),s.each(function(){t=e(this),i=t.find(".qor-table--ml-slideout p img").first(),t.find(".qor-table__actions").remove(),i.length&&(t.find(".qor-table--medialibrary-item").css("background-image","url("+i.prop("src")+")"),i.parent().remove())}),"1"!=this.bottomsheetsData.maxItem&&this.updateHint(this.getSelectedItemData())},reloadData:function(){this.$selectFeild&&this.initMedia()},renderHint:function(e){return window.Mustache.render(this.SELECT_MANY_HINT,e)},getSelectedItemData:function(t){var i=t||this.$selectFeild,o=i.find(d).not(".is_deleted"),a=[];return o.length&&o.each(function(){var t=e(this).data();a.push({ID:t.primaryKey,Url:t.originalUrl.replace(/.original.(\w+)$/,".$1"),Description:t.description,FileName:t.fileName,VideoLink:t.videolink})}),{files:a,selectedNum:a.length}},updateHint:function(t){var i;e.extend(t,this.bottomsheetsData),i=this.renderHint(t),e(".qor-selectmany__hint").remove(),this.$bottomsheets.find(".qor-page__body").before(i)},updateMediaLibraryData:function(e,t){var i=e?e.find(l):this.$selectFeild.find(l),o=this.getSelectedItemData(e);i.val(JSON.stringify(o.files)).data("mediaData",t).trigger("changed.medialibrary",[t])},changeIcon:function(t,i){var o=t.find(".qor-table--medialibrary-item"),a=o.length?o:t.find("td:first");t.find(".qor-select__select-icon").remove(),i&&("one"==i&&e("."+m).find(".qor-select__select-icon").remove(),a.prepend(this.SELECT_MANY_SELECTED_ICON))},syncImageCrop:function(t,i){var o=JSON.parse(t.find("textarea.qor-file__options").val()),a=t.data().mediaLibraryUrl,n=this,s={},d=["Width","Height"],l=void 0,m=void 0,c=t.find("img[data-size-name]");delete o.ID,delete o.Url,o.Sizes={},c.each(function(){if(m=e(this).data(),m.sizeResolutionWidth||m.sizeResolution){o.Sizes[m.sizeName]={};for(var t=0;t<d.length;t++)l=m["sizeResolution"+d[t]],l||(l=m.sizeResolution[d[t]]),o.Sizes[m.sizeName][d[t]]=l}}),s.MediaOption=JSON.stringify(o),this.addMediaLoading(t),e.ajax({type:"PUT",url:a,data:JSON.stringify(s),contentType:"application/json",dataType:"json",success:function(o){s.MediaOption=JSON.parse(o.MediaOption),t.data().originalUrl=s.MediaOption.OriginalURL,n.updateMediaLibraryData(t.closest(r),s),i&&e.isFunction(i)&&i(s,t)},complete:function(){t.find(".qor-media-loading").remove()}})},showHiddenItem:function(e){e.removeClass("is_deleted").find(".qor-file__list").show(),e.find(".qor-fieldset__alert").remove()},removeItem:function(e){var t=e.primaryKey;this.$selectFeild.find('[data-primary-key="'+t+'"]').remove(),this.changeIcon(e.$clickElement)},compareCropSizes:function(e){var t=e.MediaOption.CropOptions,i=this.bottomsheetsData.cropSizes,o=void 0,a=void 0;if(!i||"image"!=e.SelectedType)return!1;if(void 0===t)return!0;if(i=i.split(","),o=i.length-1,!window._.isObject(t))return!1;if(a=Object.keys(t),a.length)for(var n=0;n<o;n++)if(-1==a.indexOf(i[n]))return!0;return!1},addItem:function(i,o){var a=e(window.Mustache.render(this.TEMPLATE_IMAGE,i)),n=a.find(".qor-file__input"),s=n.closest(d),r=this.$selectFeild.find('[data-primary-key="'+i.primaryKey+'"]'),l=this.bottomsheetsData.maxItem,m=this.getSelectedItemData().selectedNum,c=i.MediaOption.CropOptions,h=this.compareCropSizes(i),f=i.SelectedType,u=/.svg$/.test(i.MediaOption.FileName),p=this;if(o||(1==l?this.changeIcon(i.$clickElement,"one"):this.changeIcon(i.$clickElement,!0)),l&&m>=l){if(1!=l)return void window.alert(this.bottomsheetsData.maxItemHint);this.$selectFeild.find(d).remove()}if(r.length)return this.showHiddenItem(r),void(1==l&&setTimeout(function(){p.$bottomsheets.remove(),e(".qor-bottomsheets").is(":visible")||e("body").removeClass("qor-bottomsheets-open")},1e3));1==l&&this.$selectFeild.find(d).filter(".is_deleted").remove(),u||("video"===f?a=e(window.Mustache.render(this.TEMPLATE_UPLOADEDVIDEO,i)):"video_link"===f?(i.VideoLink="//www.youtube.com/embed/"+t(i.MediaOption.Video)+"?rel=0&fs=0&modestbranding=1&disablekb=1",a=e(window.Mustache.render(this.TEMPLATE_VIDEOLINK,i))):"file"===f&&(a=e(window.Mustache.render(this.TEMPLATE_FILE,i)))),a.data({description:i.MediaOption.Description,mediaData:i,videolink:"video_link"===f?i.MediaOption.Video:""}),u&&a.addClass("is-svg").find(".qor-file__input").remove(),a.appendTo(this.$selectFeild),c&&"image"===f&&this.resetImages(i,a),"image"===f&&a.find("textarea.qor-file__options").val(JSON.stringify(i.MediaOption)),a.trigger("enable"),h&&n.data("qor.cropper")&&!u&&n.data("qor.cropper").load(i.MediaOption.URL,!0,function(){p.syncImageCrop(s,p.resetImages)}),this.$bottomsheets.find(".qor-media-loading").remove(),(o||1==l)&&setTimeout(function(){p.$bottomsheets.remove(),e(".qor-bottomsheets").is(":visible")||e("body").removeClass("qor-bottomsheets-open")},150)},resetImages:function(t,i){var o=t.MediaOption.CropOptions,a=Object.keys(o),n=t.MediaOption.OriginalURL;if(/original/.test(n)){for(var s=a.length-1;s>=0;s--)o[a[s]].URL=n.replace(/original/,a[s]);i.find("img[data-size-name]").each(function(){var t=e(this),i=(Math.random()+1).toString(36).substring(7),a=t.data().sizeName;"original"!=a&&o[a]&&t.prop("src",o[a].URL+"?"+i)})}},handleSelectMany:function(e){var t={loading:this.addMediaLoading,onSelect:this.onSelectResults.bind(this),onSubmit:this.onSubmitResults.bind(this)};e.qorSelectCore(t).addClass(m),this.$bottomsheets=e,this.initMedia()},onSelectResults:function(e){this.handleResultsData(e)},onSubmitResults:function(e){this.handleResultsData(e,!0)},handleResultsData:function(e,t){var i,o=e.$clickElement;if(e.mediaLibraryUrl||t||(e.mediaLibraryUrl=e.url),t)return e.mediaLibraryUrl=this.bottomsheetsData.mediaboxUrl+"/"+e.primaryKey,this.addItem(e,t),void this.updateDatas(e);o.toggleClass("is_selected"),i=o.hasClass("is_selected"),i?this.addItem(e):this.removeItem(e),this.updateDatas(e)},addMediaLoading:function(t){e('<div class="qor-media-loading"><div class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div></div>').appendTo(t).trigger("enable.qor.material")},updateDatas:function(e){"1"!=this.bottomsheetsData.maxItem&&this.updateHint(this.getSelectedItemData()),this.updateMediaLibraryData(null,e)},destroy:function(){this.unbind(),this.$element.removeData(n)}},i.plugin=function(t){return this.each(function(){var o,a=e(this),s=a.data(n);if(!s){if(/destroy/.test(t))return;a.data(n,s=new i(this,t))}"string"==typeof t&&e.isFunction(o=s[t])&&o.apply(s)})},e(function(){var t='[data-toggle="qor.mediabox"]';e(document).on("disable.qor.medialibrary.select",function(o){i.plugin.call(e(t,o.target),"destroy")}).on("enable.qor.medialibrary.select",function(o){i.plugin.call(e(t,o.target))}).triggerHandler("enable.qor.medialibrary.select")}),i});